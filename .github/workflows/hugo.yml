name: Build hugo site

on:
  # Runs on pushes targeting the default branch
  push:
  workflow_dispatch:

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.155.3
      HUGO_CHECKSUM: 254895d68a1aa7cc853eab10da142f7d6437d6e7fb0e7303459339dd7c2d0238
    steps:
      - name: Download Hugo CLI
        run:
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_linux-amd64.deb
      - name: Verify Hugo checksum
        run: echo "${HUGO_CHECKSUM}  ${{ runner.temp }}/hugo.deb" | sha256sum --check
      - name: Install Hugo
        run: sudo dpkg -i ${{ runner.temp }}/hugo.deb
      - name: Checkout
        uses: actions/checkout@v5
      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
        run: |
          hugo \
            --minify \
            --gc
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hugo-site
          path: ./public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download Hugo site artifact
        uses: actions/download-artifact@v5
        with:
          name: hugo-site
          path: ./hugo-site
      - name: Install rclone
        run: |
          sudo apt-get -y install rclone
      - name: "obfuscate password for rclone"
        run: |
          WEBDAV_PASSWORD=$(echo ${{ secrets.WEBDAV_PASS}} | rclone obscure -)
          echo "::add-mask::$WEBDAV_PASSWORD"
          echo "RCLONE_WEBDAV_PASS=$WEBDAV_PASSWORD" >> "$GITHUB_ENV"
      - name: "sync to target"
        run: "rclone sync ./hugo-site :webdav,env:chaoszone.cz -v"
        env:
          RCLONE_WEBDAV_URL: "https://dav.eigenbaukombinat.de"
          RCLONE_WEBDAV_USER: "githubcz"
